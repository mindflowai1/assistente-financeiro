<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conex√£o Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-box {
            background: #2a2a2a;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #059669;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            color: white;
            border-radius: 5px;
        }
        h1 {
            color: #10b981;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç Teste de Conex√£o Supabase</h1>
    
    <div class="test-box">
        <h3>1. Configurar Credenciais</h3>
        <p>Cole suas credenciais do Supabase (Settings ‚Üí API):</p>
        <input type="text" id="supabaseUrl" placeholder="Project URL: https://xxxxx.supabase.co">
        <input type="text" id="supabaseKey" placeholder="anon public key: eyJhbGciOiJI...">
        <button onclick="salvarCredenciais()">Salvar Credenciais</button>
    </div>

    <div class="test-box">
        <h3>2. Testar Conex√£o B√°sica</h3>
        <button onclick="testarConexao()">Testar Conex√£o</button>
        <div id="resultConexao" class="result"></div>
    </div>

    <div class="test-box">
        <h3>3. Testar Login</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="senha" placeholder="Senha">
        <button onclick="testarLogin()">Fazer Login</button>
        <div id="resultLogin" class="result"></div>
    </div>

    <div class="test-box">
        <h3>4. Testar Fun√ß√£o RPC</h3>
        <p>Este teste s√≥ funciona se voc√™ j√° estiver logado</p>
        <input type="password" id="senhaAtual" placeholder="Senha Atual">
        <input type="password" id="senhaNova" placeholder="Nova Senha">
        <button onclick="testarRPC()">Testar change_user_password</button>
        <div id="resultRPC" class="result"></div>
    </div>

    <script>
        let supabase = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
            element.innerHTML += `<span class="${color}">[${timestamp}] ${message}</span>\n`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function salvarCredenciais() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                alert('Por favor, preencha a URL e a chave!');
                return;
            }

            // Verificar se a biblioteca Supabase foi carregada
            if (!window.supabase) {
                alert('‚ùå Biblioteca Supabase n√£o foi carregada! Verifique sua conex√£o com a internet.');
                console.error('window.supabase est√° undefined. CDN n√£o carregou.');
                return;
            }

            try {
                // Usar window.supabase porque a lib vem do CDN
                supabase = window.supabase.createClient(url, key);
                console.log('‚úÖ Cliente Supabase criado com sucesso');
                alert('‚úÖ Credenciais salvas! Agora voc√™ pode testar a conex√£o.');
            } catch (error) {
                console.error('‚ùå Erro ao criar cliente:', error);
                alert('‚ùå Erro ao criar cliente: ' + error.message);
            }
        }

        async function testarConexao() {
            clearLog('resultConexao');

            if (!supabase) {
                log('resultConexao', '‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            log('resultConexao', 'üîÑ Testando conex√£o...', 'info');

            try {
                // Teste 1: Buscar sess√£o
                log('resultConexao', '1Ô∏è‚É£ Buscando sess√£o...', 'info');
                const start1 = performance.now();
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                const duration1 = performance.now() - start1;

                if (sessionError) {
                    log('resultConexao', `‚ùå Erro: ${sessionError.message}`, 'error');
                } else {
                    log('resultConexao', `‚úÖ Sess√£o obtida em ${duration1.toFixed(2)}ms`, 'success');
                    log('resultConexao', `   Logado: ${sessionData.session ? 'SIM' : 'N√ÉO'}`, 'info');
                }

                // Teste 2: RPC gen√©rico (vai dar erro mas testa conectividade)
                log('resultConexao', '\n2Ô∏è‚É£ Testando chamada RPC...', 'info');
                const start2 = performance.now();
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('TIMEOUT')), 5000)
                );
                
                try {
                    const rpcPromise = supabase.rpc('ping');
                    await Promise.race([rpcPromise, timeoutPromise]);
                    const duration2 = performance.now() - start2;
                    log('resultConexao', `‚úÖ RPC respondeu em ${duration2.toFixed(2)}ms`, 'success');
                } catch (err) {
                    const duration2 = performance.now() - start2;
                    if (err.message === 'TIMEOUT') {
                        log('resultConexao', `‚ùå‚ùå‚ùå TIMEOUT ap√≥s ${duration2.toFixed(2)}ms!`, 'error');
                        log('resultConexao', '‚ö†Ô∏è Supabase N√ÉO est√° respondendo chamadas RPC!', 'error');
                    } else {
                        log('resultConexao', `‚ö†Ô∏è Erro (normal se fun√ß√£o n√£o existe): ${err.message}`, 'warning');
                        log('resultConexao', `‚úÖ Mas RPC est√° funcionando! (${duration2.toFixed(2)}ms)`, 'success');
                    }
                }

                log('resultConexao', '\n‚úÖ Teste de conex√£o conclu√≠do!', 'success');

            } catch (error) {
                log('resultConexao', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testarLogin() {
            clearLog('resultLogin');

            if (!supabase) {
                log('resultLogin', '‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            if (!email || !senha) {
                log('resultLogin', '‚ùå Preencha email e senha!', 'error');
                return;
            }

            log('resultLogin', 'üîÑ Tentando fazer login...', 'info');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: senha
                });

                if (error) {
                    log('resultLogin', `‚ùå Erro: ${error.message}`, 'error');
                } else {
                    log('resultLogin', '‚úÖ Login bem-sucedido!', 'success');
                    log('resultLogin', `   User ID: ${data.user.id}`, 'info');
                    log('resultLogin', `   Email: ${data.user.email}`, 'info');
                }
            } catch (error) {
                log('resultLogin', `‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testarRPC() {
            clearLog('resultRPC');

            if (!supabase) {
                log('resultRPC', '‚ùå Configure as credenciais primeiro!', 'error');
                return;
            }

            const senhaAtual = document.getElementById('senhaAtual').value;
            const senhaNova = document.getElementById('senhaNova').value;

            if (!senhaAtual || !senhaNova) {
                log('resultRPC', '‚ùå Preencha ambas as senhas!', 'error');
                return;
            }

            log('resultRPC', 'üîÑ Testando fun√ß√£o change_user_password...', 'info');

            const start = performance.now();
            
            try {
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('TIMEOUT')), 5000)
                );
                
                const rpcPromise = supabase.rpc('change_user_password', {
                    current_password: senhaAtual,
                    new_password: senhaNova
                });

                const result = await Promise.race([rpcPromise, timeoutPromise]);
                const duration = performance.now() - start;

                log('resultRPC', `‚úÖ Fun√ß√£o respondeu em ${duration.toFixed(2)}ms`, 'success');
                log('resultRPC', `   Data: ${JSON.stringify(result.data, null, 2)}`, 'info');
                
                if (result.error) {
                    log('resultRPC', `‚ö†Ô∏è Error: ${result.error.message}`, 'warning');
                }

            } catch (error) {
                const duration = performance.now() - start;
                
                if (error.message === 'TIMEOUT') {
                    log('resultRPC', `‚ùå‚ùå‚ùå TIMEOUT ap√≥s ${duration.toFixed(2)}ms!`, 'error');
                    log('resultRPC', '‚ö†Ô∏è A fun√ß√£o N√ÉO est√° respondendo!', 'error');
                } else {
                    log('resultRPC', `‚ùå Erro: ${error.message}`, 'error');
                }
            }
        }

        // Tentar usar credenciais automaticamente ao carregar
        window.onload = () => {
            console.log('üîÑ Carregando p√°gina de teste...');
            console.log('üì¶ Biblioteca Supabase carregada:', !!window.supabase);
            
            // Preencher credenciais automaticamente
            document.getElementById('supabaseUrl').value = 'https://wgtntctzljufpikogvur.supabase.co';
            document.getElementById('supabaseKey').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndndG50Y3R6bGp1ZnBpa29ndnVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTE5MzcsImV4cCI6MjA3NTUyNzkzN30.ZuxOpQCtxBaMhXN4RrtmlSr304ENqPoF1yWumxECTPg';
            
            // Salvar automaticamente
            setTimeout(() => {
                salvarCredenciais();
            }, 100);
        };
    </script>
</body>
</html>

